from androguard.core.bytecodes.apk import APK
import numpy as np
from dexparser import Dexparser

def feature_malware(filename, vul):
    app = APK(filename)
    malware = np.zeros((1,216))
    
    EXEC=0
    # Permision
    permissions = app.get_permissions()
    # Intent
    intent_name = []
    services = app.get_services()
    serviceString = 'service'
    for service in services:
        for action, name in app.get_intent_filters(serviceString, service).items():
            for names in name:
                intent_name.append(names)
    
    receivers = app.get_receivers()
    receiverString = 'receiver'
    for receiver in receivers:
        for action, name in app.get_intent_filters(receiverString, receiver).items():
            for names in name:
                intent_name.append(names)
    # Api call signature
    cast=0
    dex_encoder=app.get_all_dex()
    for dex in dex_encoder:
        dex_decoder=Dexparser(fileobj=dex)
        apicalls = dex_decoder.get_strings()    
        for api in apicalls:      
            if b"transact" in api:
                malware[0][0]=1
                
            if b"onServiceConnected" in api:
                malware[0][1]=1 
            
            if b"bindService" in api:
                malware[0][2]=1
                
            if b"attachInterface" in api:
                malware[0][3]=1 
            
            if b"ServiceConnection" in api:
                malware[0][4]=1       
             
            if b"android/os/Binder" in api:
                malware[0][5]=1   
            
            if b"getCanonicalName" in api:
                malware[0][7]=1 
                
            if b"getMethods" in api:
                malware[0][8]=1 
            
            if b"java/lang/Class" in api:
                cast=1
            if cast == 1 and  b"cast" in api:
                malware[0][9]=1 
            
            if b"java/net/URLDecoder" in api:
                malware[0][10]=1         
            
            if b"android/content/pm/Signature" in api:
                malware[0][11]=1
                
            if b"android/telephony/SmsManager" in api:
                malware[0][12]=1
                
            if b"getBinder" in api:
                malware[0][14]=1 
                
            if b"ClassLoader" in api:
                malware[0][15]=1 
                  
            if b"registerReceiver" in api:
                malware[0][16]=1 
               
            if b"getField" in api:
                malware[0][17]=1
                
            if b"unregisterReceiver" in api:
                malware[0][18]=1            
            
            if b"getDeclaredField" in api:
                malware[0][21]=1   
            
            if b"getCallingUid" in api:
                malware[0][22]=1  
            
            if b"Ljavax/crypto/spec/SecretKeySpec" in api:
                malware[0][23]=1 
            
            if b"Landroid/content/pm/PackageInfo" in api:
                malware[0][28]=1
                
            if b"KeySpec" in api:
                malware[0][30]=1  
            
            if b"getLine1Number" in api:
                malware[0][31]=1            
                         
            if b"DexClassLoader" in api:
                malware[0][32]=1 
                        
            if b"init" in api and b"HttpGet" in api:
                malware[0][33]=1
                            
            if b"Ljavax/crypto/SecretKey" in api and b"Ljavax/crypto/spec/SecretKeySpec" not in api:
                malware[0][34]=1 
            
            if b"getMethod" in api and b"getMethods" not in api and b"getMethodName" not in api and b"getMethodOrDie" not in api:
                malware[0][35]=1  
             
            if b"loadLibrary" in api:
                malware[0][36]=1  
                        
            if b"android.intent.action.SEND" in api:
                malware[0][37]=1
                            
            if b"Ljavax/crypto/Cipher" in api:
                malware[0][38]=1
                    
            if b"android/telephony/gsm/SmsManager" in api:
                malware[0][42]=1 
            
            if b"getSubscriberId" in api:
                malware[0][44]=1
                
            if b"getRuntime" in api and b"getRuntimeVersion" not in api and b"getRuntimeName" not in api and b"getRuntimeMXBea" not in api :
                malware[0][46]=1
                
            if b"getClass" in api:
                malware[0][48]=1
                
            if b"forName" in api:
                malware[0][51]=1
                
            if b"Binder" in api and b"Landroid/os/Binder" not in api:
                malware[0][54]=1
                                        
            if b"IBinder" in api and b"Landroid/os/IBinder" not in api:
                malware[0][57]=1  
                                      
            if b"Landroid/os/IBinder" in api:
                malware[0][58]=1
                           
            if b"createSubprocess" in api:
                malware[0][59]=1
                
            if b"URLClassLoader" in api:
                malware[0][62]=1
                        
            if b"abortBroadcast" in api:
                malware[0][64]=1 
                        
            if b"getDeviceId" in api:
                malware[0][68]=1
            
            if b"getCallingPid" in api:
                malware[0][70]=1 
            
            if b"getPackage" in api:
                malware[0][78]=1            
                
            if b"getDeclaredClasses" in api:
                malware[0][80]=1 
                
            if b"PathClassLoader" in api:
                malware[0][83]=1
                
            if b"getSimSerialNumber" in api:
                malware[0][84]=1
                                
            if b"getCallState" in api:
                malware[0][86]=1
                                                
            if b"sendMultipartTextMessage" in api:
                malware[0][93]=1
            
            if b"Landroid/content/pm/PackageInstaller" in api:
                malware[0][94]=1 
            
            if b"sendDataMessage" in api:
                malware[0][98]=1            
                                                            
            if b"java/lang/Runtime" in api:
                EXEC=1
            if EXEC == 1 and b"exec" in api :
                malware[0][128]=1 
                        
            if b"MessengerService" in api:
                malware[0][142]=1
                            
            if b"SET_ALARM" in api:
                malware[0][147]=1 
                            
            if b"ACCOUNT_MANAGER" in api:
                malware[0][148]=1 
                
            if b"getSimOperator" in api:
                malware[0][152]=1
                        
            if b"onBind" in api:
                malware[0][155]=1
                                                            
            if b"bindService" in api:
                malware[0][158]=1
            
            if b"ProcessBuilder" in api:
                malware[0][167]=1 
            
            if b"getResources" in api:
                malware[0][171]=1
                                                                    
            if b"loadLibrary" in api:
                malware[0][190]=1 
                
            if b"getInstalledPackages" in api:
                malware[0][109]=1 
            
            if b"getServiceCenterAddress" in api:
                malware[0][104]=1 
                
            if b"sendTextMessage" in api:
                malware[0][102]=1 
            
            if b"PhoneCallReceiver" in api:
                malware[0][101]=1 
            
            if b"getDataActivity" in api:
                malware[0][100]=1    
            
            if b"getActivityNetworkInfo" in api:
                malware[0][96]=1 
                
            if b"getSupplicantState" in api:
                malware[0][85]=1 
            
            if b"getNetworkType" in api:
                malware[0][79]=1
                
            if "getConnectionInfo"  in permissions:
                malware[0][29]=1
                
            if "getSimState"  in permissions:
                malware[0][25]=1        
                                
        if "android.permission.SEND_SMS"  in permissions:
            malware[0][6]=1
            
        if "android.permission.READ_PHONE_STATE"  in permissions:
            malware[0][13]=1 
        
        if "android.permission.GET_ACCOUNTS"  in permissions:
            malware[0][19]=1
            
        if "android.permission.RECEIVE_SMS"  in permissions:
            malware[0][20]=1
            
        if "android.permission.READ_SMS"  in permissions:
            malware[0][24]=1 
            
        if "android.intent.action.BOOT_COMPLETED"  in intent_name:
            malware[0][26]=1
        
        if "android.permission.USE_CREDENTIALS"  in permissions:
            malware[0][27]=1
            
        if "android.permission.MANAGE_ACCOUNTS"  in permissions:
            malware[0][28]=1
            
        if "android.permission.WRITE_SMS"  in permissions:
            malware[0][38]=1 
        
        if "android.permission.READ_SYNC_SETTINGS"  in permissions:
            malware[0][40]=1
            
        if "android.permission.AUTHENTICATE_ACCOUNTS"  in permissions:
            malware[0][41]=1
            
        if "android.permission.WRITE_HISTORY_BOOKMARKS"  in permissions:
            malware[0][43]=1 
        
        if "android.permission.INSTALL_PACKAGES"  in permissions:
            malware[0][45]=1
            
        if "android.permission.CAMERA"  in permissions:
            malware[0][47]=1
            
        if "android.permission.WRITE_SYNC_SETTINGS"  in permissions:
            malware[0][49]=1 
        
        if "android.permission.READ_HISTORY_BOOKMARKS"  in permissions:
            malware[0][50]=1
            
        if "android.permission.INTERNET"  in permissions:
            malware[0][52]=1
        
        if "android.intent.action.PACKAGE_REPLACED"  in intent_name:
            malware[0][53]=1
            
        if "android.intent.action.SEND_MULTIPLE"  in intent_name:
            malware[0][55]=1 
        
        if "android.permission.RECORD_AUDIO"  in permissions:
            malware[0][56]=1
        
        if "android.permission.NFC"  in permissions:
            malware[0][60]=1
            
        if "android.permission.ACCESS_LOCATION_EXTRA_COMMANDS"  in permissions:
            malware[0][61]=1
            
        if "android.permission.WRITE_APN_SETTINGS"  in permissions:
            malware[0][63]=1 
        
        if "android.permission.BIND_REMOTEVIEWS"  in permissions:
            malware[0][65]=1
            
        if "android.intent.action.TIME_SET"  in intent_name:
            malware[0][66]=1 
            
        if "android.permission.READ_PROFILE"  in permissions:
            malware[0][67]=1
            
        if "android.permission.MODIFY_AUDIO_SETTINGS"  in permissions:
            malware[0][69]=1 
        
        if "android.permission.READ_SYNC_STATS"  in permissions:
            malware[0][71]=1
            
        if "android.permission.BROADCAST_STICKY"  in permissions:
            malware[0][72]=1
            
        if "android.intent.action.PACKAGE_REMOVED"  in intent_name:
            malware[0][73]=1
            
        if "android.intent.action.TIMEZONE_CHANGED"  in intent_name:
            malware[0][74]=1    
        
        if "android.permission.WAKE_LOCK"  in permissions:
            malware[0][75]=1
            
        if "android.permission.RECEIVE_BOOT_COMPLETED"  in permissions:
            malware[0][76]=1
            
        if "android.permission.RESTART_PACKAGES"  in permissions:
            malware[0][77]=1 
        
        if "android.intent.action.ACTION_POWER_DISCONNECTED"  in intent_name:
            malware[0][81]=1
            
        if "android.intent.action.PACKAGE_ADDED"  in intent_name:
            malware[0][82]=1 
        
        if "android.permission.BLUETOOTH"  in permissions:
            malware[0][87]=1
            
        if "android.permission.READ_CALENDAR"  in permissions:
            malware[0][88]=1
            
        if "android.permission.READ_CALL_LOG"  in permissions:
            malware[0][89]=1 
        
        if "android.permission.SUBSCRIBED_FEEDS_WRITE"  in permissions:
            malware[0][90]=1
            
        if "android.permission.READ_EXTERNAL_STORAGE"  in permissions:
            malware[0][91]=1
            
        if "android.permission.VIBRATE"  in permissions:
            malware[0][95]=1 
            
        if "android.intent.action.ACTION_SHUTDOWN"  in intent_name:
            malware[0][97]=1     
        
        if "android.permission.ACCESS_NETWORK_STATE"  in permissions:
            malware[0][99]=1
            
        if "android.permission.SUBSCRIBED_FEEDS_READ"  in permissions:
            malware[0][103]=1
            
        if "android.permission.CHANGE_WIFI_MULTICAST_STATE"  in permissions:
            malware[0][105]=1 
        
        if "android.permission.WRITE_CALENDAR"  in permissions:
            malware[0][106]=1
            
        if "android.intent.action.PACKAGE_DATA_CLEARED"  in intent_name:
            malware[0][107]=1
            
        if "android.permission.MASTER_CLEAR"  in permissions:
            malware[0][108]=1
            
        if "android.permission.UPDATE_DEVICE_STATS"  in permissions:
            malware[0][110]=1 
        
        if "android.permission.WRITE_CALL_LOG"  in permissions:
            malware[0][111]=1
            
        if "android.permission.DELETE_PACKAGES"  in permissions:
            malware[0][112]=1
            
        if "android.permission.GET_TASKS"  in permissions:
            malware[0][113]=1 
        
        if "android.permission.GLOBAL_SEARCH"  in permissions:
            malware[0][114]=1
            
        if "android.permission.DELETE_CACHE_FILES"  in permissions:
            malware[0][115]=1
            
        if "android.permission.WRITE_USER_DICTIONARY"  in permissions:
            malware[0][116]=1
            
        if "android.intent.action.PACKAGE_CHANGED"  in intent_name:
            malware[0][117]=1
            
        if "android.intent.action.NEW_OUTGOING_CALL"  in intent_name:
            malware[0][118]=1 
        
        if "android.permission.REORDER_TASKS"  in permissions:
            malware[0][119]=1
            
        if "android.permission.WRITE_PROFILE"  in permissions:
            malware[0][120]=1
            
        if "android.permission.SET_WALLPAPER"  in permissions:
            malware[0][121]=1 
        
        if "android.permission.BIND_INPUT_METHOD"  in permissions:
            malware[0][122]=1
            
        if "android.permission.READ_SOCIAL_STREAM"  in permissions:
            malware[0][124]=1
            
        if "android.permission.READ_USER_DICTIONARY"  in permissions:
            malware[0][125]=1 
        
        if "android.permission.PROCESS_OUTGOING_CALLS"  in permissions:
            malware[0][126]=1
            
        if "android.permission.CALL_PRIVILEGED"  in permissions:
            malware[0][127]=1 
        
        if "android.permission.BIND_WALLPAPER"  in permissions:
            malware[0][129]=1
            
        if "android.permission.RECEIVE_WAP_PUSH"  in permissions:
            malware[0][130]=1
            
        if "android.permission.DUMP"  in permissions:
            malware[0][131]=1 
        
        if "android.permission.BATTERY_STATS"  in permissions:
            malware[0][132]=1    
            
        if "android.permission.ACCESS_COARSE_LOCATION"  in permissions:
            malware[0][133]=1
            
        if "android.permission.SET_TIME"  in permissions:
            malware[0][134]=1 
            
        if "android.intent.action.SENDTO"  in intent_name:
            malware[0][135]=1 
        
        if "android.permission.WRITE_SOCIAL_STREAM"  in permissions:
            malware[0][136]=1
            
        if "android.permission.WRITE_SETTINGS"  in permissions:
            malware[0][137]=1
            
        if "android.permission.REBOOT"  in permissions:
            malware[0][138]=1 
        
        if "android.permission.BLUETOOTH_ADMIN"  in permissions:
            malware[0][139]=1
            
        if "android.permission.BIND_DEVICE_ADMIN"  in permissions:
            malware[0][143]=1
            
        if "android.permission.WRITE_GSERVICES"  in permissions:
            malware[0][144]=1 
        
        if "android.permission.KILL_BACKGROUND_PROCESSES"  in permissions:
            malware[0][146]=1
        
        if "android.intent.action.CALL"  in intent_name:
            malware[0][150]=1
            
        if "android.permission.STATUS_BAR"  in permissions:
            malware[0][151]=1
            
        if "android.permission.PERSISTENT_ACTIVITY"  in permissions:
            malware[0][153]=1 
        
        if "android.permission.CHANGE_NETWORK_STATE"  in permissions:
            malware[0][154]=1
        
        if "android.intent.action.SCREEN_ON"  in intent_name:
            malware[0][157]=1
            
        if "android.permission.RECEIVE_MMS"  in permissions:
            malware[0][159]=1
         
        if "android.intent.action.SET_TIME_ZONE"  in intent_name:
            malware[0][160]=1 
         
        if "android.intent.action.BATTERY_OKAY"  in intent_name:
            malware[0][161]=1  
            
        if "android.permission.CONTROL_LOCATION_UPDATES"  in permissions:
            malware[0][162]=1 
        
        if "android.permission.BROADCAST_WAP_PUSH"  in permissions:
            malware[0][163]=1
            
        if "android.permission.BIND_ACCESSIBILITY_SERVICE"  in permissions:
            malware[0][164]=1
            
        if "android.permission.ADD_VOICEMAIL"  in permissions:
            malware[0][165]=1 
        
        if "android.permission.CALL_PHONE"  in permissions:
            malware[0][166]=1
            
        if "android.permission.BIND_APPWIDGET"  in permissions:
            malware[0][168]=1
            
        if "android.permission.FLASHLIGHT"  in permissions:
            malware[0][169]=1 
        
        if "android.permission.READ_LOGS"  in permissions:
            malware[0][170]=1
            
        if "android.permission.SET_PROCESS_LIMIT"  in permissions:
            malware[0][173]=1
           
        if "android.intent.action.PACKAGE_RESTARTED"  in intent_name:
            malware[0][174]=1
            
        if "android.permission.MOUNT_UNMOUNT_FILESYSTEMS"  in permissions:
            malware[0][175]=1 
        
        if "android.permission.BIND_TEXT_SERVICE"  in permissions:
            malware[0][176]=1
            
        if "android.permission.INSTALL_LOCATION_PROVIDER"  in permissions:
            malware[0][177]=1 
            
        if "android.intent.action.CALL_BUTTON"  in intent_name:
            malware[0][178]=1
            
        if "android.intent.action.SCREEN_OFF"  in intent_name:
            malware[0][179]=1 
        
        if "android.permission.SYSTEM_ALERT_WINDOW"  in permissions:
            malware[0][181]=1
            
        if "android.permission.MOUNT_FORMAT_FILESYSTEMS"  in permissions:
            malware[0][182]=1
            
        if "android.permission.CHANGE_CONFIGURATION"  in permissions:
            malware[0][183]=1 
        
        if "android.permission.CLEAR_APP_USER_DATA"  in permissions:
            malware[0][184]=1
        
        if "android.intent.action.RUN"  in intent_name:
            malware[0][185]=1
        
        if "android.intent.action.SET_WALLPAPER"  in intent_name:
            malware[0][186]=1
            
        if "android.permission.CHANGE_WIFI_STATE"  in permissions:
            malware[0][187]=1
            
        if "android.permission.READ_FRAME_BUFFER"  in permissions:
            malware[0][188]=1 
        
        if "android.permission.ACCESS_SURFACE_FLINGER"  in permissions:
            malware[0][189]=1
            
        if "android.permission.BROADCAST_SMS"  in permissions:
            malware[0][191]=1
            
        if "android.permission.EXPAND_STATUS_BAR"  in permissions:
            malware[0][192]=1 
        
        if "android.permission.INTERNAL_SYSTEM_WINDOW"  in permissions:
            malware[0][193]=1
         
        if "android.intent.action.BATTERY_LOW"  in intent_name:
            malware[0][194]=1 
            
        if "android.permission.SET_ACTIVITY_WATCHER"  in permissions:
            malware[0][195]=1
            
        if "android.permission.WRITE_CONTACTS"  in permissions:
            malware[0][196]=1 
            
        if "android.intent.action.ACTION_POWER_CONNECTED"  in intent_name:
            malware[0][197]=1    
        
        if "android.permission.BIND_VPN_SERVICE"  in permissions:
            malware[0][198]=1
            
        if "android.permission.DISABLE_KEYGUARD"  in permissions:
            malware[0][199]=1
            
        if "android.permission.ACCESS_MOCK_LOCATION"  in permissions:
            malware[0][200]=1 
        
        if "android.permission.GET_PACKAGE_SIZE"  in permissions:
            malware[0][201]=1
            
        if "android.permission.MODIFY_PHONE_STATE"  in permissions:
            malware[0][202]=1
            
        if "android.permission.CHANGE_COMPONENT_ENABLED_STATE"  in permissions:
            malware[0][203]=1 
        
        if "android.permission.CLEAR_APP_CACHE"  in permissions:
            malware[0][204]=1
            
        if "android.permission.SET_ORIENTATION"  in permissions:
            malware[0][205]=1
            
        if "android.permission.READ_CONTACTS"  in permissions:
            malware[0][206]=1 
        
        if "android.permission.DEVICE_POWER"  in permissions:
            malware[0][207]=1
            
        if "android.permission.HARDWARE_TEST"  in permissions:
            malware[0][208]=1
            
        if "android.permission.ACCESS_WIFI_STAT"  in permissions:
            malware[0][209]=1 
        
        if "android.permission.WRITE_EXTERNAL_STORAGE"  in permissions:
            malware[0][180]=1
        
        if "android.permission.ACCESS_FINE_LOCATION"  in permissions:
            malware[0][172]=1
            
        if "android.permission.SET_WALLPAPER_HINTS"  in permissions:
            malware[0][156]=1
            
        if "android.permission.SET_PREFERRED_APPLICATIONS"  in permissions:
            malware[0][149]=1 
        
        if "android.permission.WRITE_SECURE_SETTINGS"  in permissions:
            malware[0][145]=1
            
        if "android.permission.ACCESS_CACHE_FILESYSTEM"  in permissions:
            malware[0][141]=1
            
        if "android.permission.WRITE_OWNER_DATA"  in permissions:
            malware[0][140]=1 
        
        if "android.permission.ACCESS_WIFI_STATE"  in permissions:
            malware[0][92]=1 
            
        if "android.intent.action.BOOT_COMPLETED"  in permissions:
            malware[0][39]=1   
            
        if "android.intent.action.CREATE_SHORTCUT"  in intent_name:
            malware[0][210]=1 
            
        if "android.intent.action.MAIN"  in intent_name:
            malware[0][211]=1
            
        if "android.intent.action.MY_PACKAGE_REPLACED"  in intent_name:
            malware[0][212]=1 
            
        if "android.intent.action.USER_PRESENT"  in intent_name:
            malware[0][213]=1
            
        if "android.intent.action.VIEW"  in intent_name:
            malware[0][214]=1

    if vul=="SMS":
        malware[0][215]=1
    elif vul=="Riskware":
        malware[0][215]=2
    elif vul=="Adware":
        malware[0][215]=3
    elif vul=="Banking":
        malware[0][215]=4
    elif vul=="Benign":
        malware[0][215]=0
    
    return malware

#medidas_encoder = feature_malware(filename)
#feature = np.array(medidas_encoder)
#sol = prediction_malware(feature)
from os import scandir, getcwd

def ls(ruta = getcwd()):
    return [arch.name for arch in scandir(ruta) if arch.is_file()]


ini=False
listavul = ["Benign", "SMS", "Riskware", "Adware", "Banking"]
with open('Dataset.txt','ab') as f:
    for y in listavul:
        listaAPK = ls("C:/Users/aloac/Desktop/Universidad/NICS Lab/Articulo ataques ML/Malware/Dataset/"+y)
        for x in listaAPK:
            try:
                medidas_encoder = feature_malware("C:/Users/aloac/Desktop/Universidad/NICS Lab/Articulo ataques ML/Malware/Dataset/"+y+"/"+x, y)
                feature = np.array(medidas_encoder)
                if (ini==False):
                    listofeature = feature
                    ini = True
                else:
                    listofeature = (listofeature, feature)
                np.savetxt(f, feature, fmt='%d', delimiter=',')
            except:
                print("Elimina "+x)
